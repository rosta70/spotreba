<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sledov√°n√≠ spot≈ôeby energi√≠</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        label {
            display: inline-block;
            width: 180px;
            font-weight: bold;
            margin-right: 10px;
        }
        input, button, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 0;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            border: none;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.delete-btn {
            background-color: #e74c3c;
        }
        button.delete-btn:hover {
            background-color: #c0392b;
        }
        button.lock-btn {
            background-color: #2ecc71;
        }
        button.lock-btn:hover {
            background-color: #27ae60;
        }
        button.lock-btn.unlocked {
            background-color: #f39c12;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .year-selector {
            margin-bottom: 15px;
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }
        .chart-wrapper {
            flex: 1 1 45%;
            min-width: 300px;
            height: 300px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .saved-data {
            margin-top: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        #yearly-totals {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            min-width: 800px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .action-col {
            width: 60px;
        }
        .editable-row {
            background-color: #fffacd !important;
        }
        .editable-row input, .editable-row .diff-input {
            width: 80px;
            padding: 4px;
            border: 1px solid #3498db;
            border-radius: 3px;
        }
        .diff-save-btn {
            background-color: #2ecc71;
            padding: 2px 8px;
            margin-left: 5px;
        }
        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            label {
                width: 100%;
                margin-bottom: 5px;
            }
            .chart-wrapper {
                flex: 1 1 100%;
            }
            .action-col {
                width: 50px;
            }
            .editable-row input, .editable-row .diff-input {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <h1>Sledov√°n√≠ spot≈ôeby energi√≠</h1>
    
    <div class="form-container">
        <h2>Zadat nov√° data</h2>
        <div class="form-group">
            <label for="date">Datum:</label>
            <input type="date" id="date" required>
        </div>
        <div class="form-group">
            <label for="gas">Plyn (m¬≥):</label>
            <input type="number" id="gas" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="water">Voda (m¬≥):</label>
            <input type="number" id="water" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="elec-low">Elekt≈ôina n√≠zk√Ω tarif (kWh):</label>
            <input type="number" id="elec-low" step="0.01 min="0">
        </div>
        <div class="form-group">
            <label for="elec-high">Elekt≈ôina vysok√Ω tarif (kWh):</label>
            <input type="number" id="elec-high" step="0.01" min="0">
        </div>
        <div class="buttons">
            <button id="save-btn">Ulo≈æit data</button>
            <button id="clear-btn">Vyƒçistit formul√°≈ô</button>
            <button id="export-btn">Exportovat data (JSON)</button>
            <input type="file" id="import-file" accept=".json" style="display: none;">
            <button id="import-btn">Importovat data</button>
        </div>
    </div>

    <div class="controls">
        <div class="year-selector">
            <label for="year-select">Filtr roku:</label>
            <select id="year-select">
                <option value="all">V≈°echny roky</option>
                <!-- Roky se dopln√≠ dynamicky -->
            </select>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-wrapper">
            <canvas id="gasChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="waterChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="elecLowChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="elecHighChart"></canvas>
        </div>
    </div>

    <div class="saved-data">
        <h2>Ulo≈æen√° data</h2>
        <div id="yearly-totals"></div>
        <table id="saved-data-table">
            <thead>
                <tr>
                    <th class="action-col">Akce</th>
                    <th>Datum</th>
                    <th>Plyn (m¬≥)</th>
                    <th>Voda (m¬≥)</th>
                    <th>Elekt≈ôina NT (kWh)</th>
                    <th>Elekt≈ôina VT (kWh)</th>
                    <th>Rozd√≠l plynu</th>
                    <th>Rozd√≠l vody</th>
                    <th>Rozd√≠l NT</th>
                    <th>Rozd√≠l VT</th>
                </tr>
            </thead>
            <tbody id="saved-data-body">
                <!-- Data se dopln√≠ dynamicky -->
            </tbody>
        </table>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let consumptionData = [];
        let charts = {
            gas: null,
            water: null,
            elecLow: null,
            elecHigh: null
        };
        let currentlyEditingRow = null;
        let cachedFilteredData = [];
        let cachedSelectedYear = '';
        let saveTimeout = null;
        let availableYears = [];
        
        // Optimalizace: P≈ôiprav√≠me si tyto promƒõnn√© pro ƒçast√© dotazy
        const dateInput = document.getElementById('date');
        const gasInput = document.getElementById('gas');
        const waterInput = document.getElementById('water');
        const elecLowInput = document.getElementById('elec-low');
        const elecHighInput = document.getElementById('elec-high');
        const yearSelect = document.getElementById('year-select');
        const savedDataBody = document.getElementById('saved-data-body');
        const yearlyTotalsDiv = document.getElementById('yearly-totals');

        // Inicializace aplikace
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
            
            // Nastav√≠me dne≈°n√≠ datum jako v√Ωchoz√≠
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        });

        function init() {
            updateYearSelector();
            updateSavedDataTable();
            updateCharts();
            displayYearlyTotals();
            
            // Diagnostika v√Ωkonu
            if (consumptionData.length > 100) {
                measureFilterPerformance();
            }
        }

        function setupEventListeners() {
            document.getElementById('save-btn').addEventListener('click', saveData);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            document.getElementById('import-file').addEventListener('change', importData);
        }

        function loadData() {
            const savedData = localStorage.getItem('consumptionData');
            if (savedData) {
                try {
                    // Parse a ulo≈æen√≠ dat
                    consumptionData = JSON.parse(savedData);
                    availableYears = [...new Set(consumptionData.map(item => item.date.split('-')[0]))];
                    
                    // V√Ωpoƒçet rozd√≠l≈Ø
                    calculateDifferences();
                    
                    // Se≈ôazen√≠ od nejnovƒõj≈°√≠ch
                    sortDataByDateDesc();
                    
                    // Inicializace UI
                    init();
                } catch (error) {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', error);
                    consumptionData = [];
                }
            } else {
                consumptionData = [];
            }
        }

        function saveDataToStorage() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Ukl√°d√°me s throttlingem (maxim√°lnƒõ 1x za sekundu)
            saveTimeout = setTimeout(() => {
                localStorage.setItem('consumptionData', JSON.stringify(consumptionData));
                saveTimeout = null;
            }, 1000);
        }

        function sortDataByDateDesc() {
            consumptionData.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function calculateDifferences() {
            if (consumptionData.length < 2) return;
            
            // Pro v√Ωpoƒçet pot≈ôebujeme data od nejstar≈°√≠ho
            const sortedData = [...consumptionData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Optimalizace: pou≈æijeme klasick√Ω for loop (rychlej≈°√≠ ne≈æ forEach)
            for (let i = 1, len = sortedData.length; i < len; i++) {
                const prev = sortedData[i - 1];
                const current = sortedData[i];
                
                if (current.gasDiff === undefined) current.gasDiff = (current.gas - prev.gas) || 0;
                if (current.waterDiff === undefined) current.waterDiff = (current.water - prev.water) || 0;
                if (current.elecLowDiff === undefined) current.elecLowDiff = (current.elecLow - prev.elecLow) || 0;
                if (current.elecHighDiff === undefined) current.elecHighDiff = (current.elecHigh - prev.elecHigh) || 0;
            }
            
            // Aktualizujeme p≈Øvodn√≠ data (kter√° jsou se≈ôazen√° od nejnovƒõj≈°√≠ch)
            const dateMap = new Map(sortedData.map(item => [item.date, item]));
            consumptionData.forEach(item => {
                const updatedItem = dateMap.get(item.date);
                if (updatedItem) {
                    if (updatedItem.gasDiff !== undefined) item.gasDiff = updatedItem.gasDiff;
                    if (updatedItem.waterDiff !== undefined) item.waterDiff = updatedItem.waterDiff;
                    if (updatedItem.elecLowDiff !== undefined) item.elecLowDiff = updatedItem.elecLowDiff;
                    if (updatedItem.elecHighDiff !== undefined) item.elecHighDiff = updatedItem.elecHighDiff;
                }
            });
        }

        function updateYearSelector() {
            yearSelect.innerHTML = '<option value="all">V≈°echny roky</option>';
            
            // P≈ôid√°me roky sestupnƒõ
            availableYears.sort().reverse().forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });

            yearSelect.addEventListener('change', () => {
                updateSavedDataTable();
                updateCharts();
                displayYearlyTotals();
            });
        }

        function updateSavedDataTable() {
            const selectedYear = yearSelect.value;
            
            // Pou≈æij cache pokud se rok nezmƒõnil
            if (cachedSelectedYear === selectedYear) {
                renderTable(cachedFilteredData);
                return;
            }
            
            // Filtruj pouze kdy≈æ se zmƒõnil rok
            const startTime = performance.now();
            
            cachedFilteredData = selectedYear === 'all' 
                ? [...consumptionData] 
                : consumptionData.filter(item => item.date.startsWith(selectedYear));
            
            cachedSelectedYear = selectedYear;
            renderTable(cachedFilteredData);
            
            console.log(`Filtrace trvala: ${performance.now() - startTime}ms`);
        }

        function renderTable(data) {
            // Optimalizace: pou≈æij DocumentFragment pro minimalizaci reflow
            const fragment = document.createDocumentFragment();
            
            // Optimalizace: p≈ôedp≈ôiprav√≠me ≈°ablonu HTML
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.setAttribute('data-index', index);
                row.innerHTML = `
                    <td class="action-col">
                        <button class="lock-btn" data-index="${index}">üîí</button>
                        <button class="delete-btn" data-index="${index}">üóëÔ∏è</button>
                    </td>
                    <td class="date-cell">${item.date}</td>
                    <td class="gas-cell">${item.gas?.toFixed(2) ?? '-'}</td>
                    <td class="water-cell">${item.water?.toFixed(2) ?? '-'}</td>
                    <td class="elecLow-cell">${item.elecLow?.toFixed(2) ?? '-'}</td>
                    <td class="elecHigh-cell">${item.elecHigh?.toFixed(2) ?? '-'}</td>
                    <td class="gasDiff-cell">${item.gasDiff?.toFixed(2) ?? '-'}</td>
                    <td class="waterDiff-cell">${item.waterDiff?.toFixed(2) ?? '-'}</td>
                    <td class="elecLowDiff-cell">${item.elecLowDiff?.toFixed(2) ?? '-'}</td>
                    <td class="elecHighDiff-cell">${item.elecHighDiff?.toFixed(2) ?? '-'}</td>
                `;
                fragment.appendChild(row);
            });
            
            // Vymƒõn√≠me obsah najednou
            savedDataBody.innerHTML = '';
            savedDataBody.appendChild(fragment);
            
            // Event listenery p≈ôid√°me najednou po renderov√°n√≠
            savedDataBody.querySelectorAll('.lock-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    toggleEditMode(index, e.target);
                });
            });
            
            savedDataBody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    deleteData(index);
                });
            });
        }

        function toggleEditMode(index, button) {
            const row = savedDataBody.querySelector(`tr[data-index="${index}"]`);
            
            if (currentlyEditingRow !== null && currentlyEditingRow !== index) {
                // Ulo≈æ√≠me p≈ôedchoz√≠ editaci
                saveRowEdit(currentlyEditingRow);
                // Vypneme editaci p≈ôedchoz√≠ho ≈ô√°dku
                disableEditMode(currentlyEditingRow);
            }
            
            if (button.textContent === 'üîí') {
                // Zapnut√≠ editace
                button.textContent = 'üîì';
                button.classList.add('unlocked');
                row.classList.add('editable-row');
                
                // Nahrad√≠me bu≈àky inputy s aktu√°ln√≠mi hodnotami
                const item = cachedFilteredData[index];
                
                row.querySelector('.date-cell').innerHTML = 
                    `<input type="date" value="${item.date}" class="date-input">`;
                
                row.querySelector('.gas-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.gas || 0}" class="gas-input">`;
                
                row.querySelector('.water-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.water || 0}" class="water-input">`;
                
                row.querySelector('.elecLow-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.elecLow || 0}" class="elecLow-input">`;
                
                row.querySelector('.elecHigh-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.elecHigh || 0}" class="elecHigh-input">`;
                
                row.querySelector('.gasDiff-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.gasDiff || 0}" class="diff-input">`;
                
                row.querySelector('.waterDiff-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.waterDiff || 0}" class="diff-input">`;
                
                row.querySelector('.elecLowDiff-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.elecLowDiff || 0}" class="diff-input">`;
                
                row.querySelector('.elecHighDiff-cell').innerHTML = 
                    `<input type="number" step="0.01" value="${item.elecHighDiff || 0}" class="diff-input">`;
                
                currentlyEditingRow = index;
            } else {
                // Vypnut√≠ editace a ulo≈æen√≠
                saveRowEdit(index);
                disableEditMode(index);
                currentlyEditingRow = null;
            }
        }

        function saveRowEdit(index) {
            const row = savedDataBody.querySelector(`tr[data-index="${index}"]`);
            if (!row) return;
            
            const updatedItem = {
                date: row.querySelector('.date-input').value,
                gas: parseFloat(row.querySelector('.gas-input').value) || 0,
                water: parseFloat(row.querySelector('.water-input').value) || 0,
                elecLow: parseFloat(row.querySelector('.elecLow-input').value) || 0,
                elecHigh: parseFloat(row.querySelector('.elecHigh-input').value) || 0,
                gasDiff: parseFloat(row.querySelector('.gasDiff-cell input').value) || 0,
                waterDiff: parseFloat(row.querySelector('.waterDiff-cell input').value) || 0,
                elecLowDiff: parseFloat(row.querySelector('.elecLowDiff-cell input').value) || 0,
                elecHighDiff: parseFloat(row.querySelector('.elecHighDiff-cell input').value) || 0
            };
            
            // Najdeme p≈Øvodn√≠ z√°znam v hlavn√≠m datasetu
            const originalIndex = consumptionData.findIndex(item => 
                item.date === cachedFilteredData[index].date);
            
            if (originalIndex !== -1) {
                consumptionData[originalIndex] = updatedItem;
                // Aktualizovat i cache
                cachedFilteredData[index] = updatedItem;
                
                sortDataByDateDesc();
                saveDataToStorage();
                updateSavedDataTable();
                updateCharts();
                displayYearlyTotals();
            }
        }

        function disableEditMode(index) {
            const row = savedDataBody.querySelector(`tr[data-index="${index}"]`);
            if (!row) return;
            
            row.classList.remove('editable-row');
            const button = row.querySelector('.lock-btn');
            if (button) {
                button.textContent = 'üîí';
                button.classList.remove('unlocked');
            }
        }

        function displayYearlyTotals() {
            const sums = calculateYearlySums();
            const selectedYear = yearSelect.value;

            yearlyTotalsDiv.innerHTML = '<h3>Roƒçn√≠ souƒçty</h3>';
            
            if (selectedYear === 'all') {
                // Zobrazujeme roky sestupnƒõ
                Object.keys(sums).sort().reverse().forEach(year => {
                    yearlyTotalsDiv.innerHTML += `
                        <p>
                            <strong>${year}:</strong> 
                            Plyn: ${sums[year].gas.toFixed(2)} m¬≥ | 
                            Voda: ${sums[year].water.toFixed(2)} m¬≥ | 
                            Elekt≈ôina (NT): ${sums[year].elecLow.toFixed(2)} kWh | 
                            Elekt≈ôina (VT): ${sums[year].elecHigh.toFixed(2)} kWh |
                            <strong>Celkem: ${sums[year].elecTotal.toFixed(2)} kWh</strong>
                        </p>
                    `;
                });
            } else if (sums[selectedYear]) {
                yearlyTotalsDiv.innerHTML += `
                    <p>
                        <strong>${selectedYear}:</strong> 
                        Plyn: ${sums[selectedYear].gas.toFixed(2)} m¬≥ | 
                        Voda: ${sums[selectedYear].water.toFixed(2)} m¬≥ | 
                        Elekt≈ôina (NT): ${sums[selectedYear].elecLow.toFixed(2)} kWh | 
                        Elekt≈ôina (VT): ${sums[selectedYear].elecHigh.toFixed(2)} kWh |
                        <strong>Celkem: ${sums[selectedYear].elecTotal.toFixed(2)} kWh</strong>
                    </p>
                `;
            } else {
                yearlyTotalsDiv.innerHTML += '<p>Pro vybran√Ω rok nejsou data.</p>';
            }
        }

        function calculateYearlySums() {
            const yearlySums = {};
            
            // Pro v√Ωpoƒçet pot≈ôebujeme data od nejstar≈°√≠ch
            const sortedData = [...consumptionData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedData.forEach(item => {
                if (item.gasDiff === undefined && item.waterDiff === undefined && 
                    item.elecLowDiff === undefined && item.elecHighDiff === undefined) return;
                
                const year = item.date.split('-')[0];
                if (!yearlySums[year]) {
                    yearlySums[year] = { 
                        gas: 0, 
                        water: 0, 
                        elecLow: 0, 
                        elecHigh: 0, 
                        elecTotal: 0 
                    };
                }
                
                yearlySums[year].gas += item.gasDiff || 0;
                yearlySums[year].water += item.waterDiff || 0;
                yearlySums[year].elecLow += item.elecLowDiff || 0;
                yearlySums[year].elecHigh += item.elecHighDiff || 0;
                yearlySums[year].elecTotal += (item.elecLowDiff || 0) + (item.elecHighDiff || 0);
            });
            
            return yearlySums;
        }

        function updateCharts() {
            const selectedYear = yearSelect.value;
            
            let filteredData = [...consumptionData];
            if (selectedYear !== 'all') {
                filteredData = filteredData.filter(item => item.date.startsWith(selectedYear));
            }
            
            // Pro grafy pot≈ôebujeme se≈ôadit data od nejstar≈°√≠ho
            const sortedData = [...filteredData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // P≈ô√≠prava dat pro grafy
            const labels = sortedData.map(item => item.date);
            const gasData = sortedData.map(item => item.gasDiff || 0);
            const waterData = sortedData.map(item => item.waterDiff || 0);
            const elecLowData = sortedData.map(item => item.elecLowDiff || 0);
            const elecHighData = sortedData.map(item => item.elecHighDiff || 0);
            
            // Aktualizace nebo vytvo≈ôen√≠ graf≈Ø
            updateChart('gasChart', 'Plyn (m¬≥)', labels, gasData, '#e74c3c');
            updateChart('waterChart', 'Voda (m¬≥)', labels, waterData, '#3498db');
            updateChart('elecLowChart', 'Elekt≈ôina NT (kWh)', labels, elecLowData, '#f1c40f');
            updateChart('elecHighChart', 'Elekt≈ôina VT (kWh)', labels, elecHighData, '#e67e22');
        }

        function updateChart(canvasId, label, labels, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Datum'
                            }
                        }
                    }
                }
            });
        }

        function saveData() {
            const date = dateInput.value;
            const gas = parseFloat(gasInput.value) || 0;
            const water = parseFloat(waterInput.value) || 0;
            const elecLow = parseFloat(elecLowInput.value) || 0;
            const elecHigh = parseFloat(elecHighInput.value) || 0;
            
            if (!date) {
                alert('Pros√≠m zadejte datum!');
                return;
            }
            
            const newEntry = {
                date,
                gas,
                water,
                elecLow,
                elecHigh
            };
            
            consumptionData.push(newEntry);
            calculateDifferences();
            sortDataByDateDesc();
            saveDataToStorage();
            updateYearSelector();
            updateSavedDataTable();
            updateCharts();
            displayYearlyTotals();
            clearForm();
        }

        function deleteData(index) {
            if (confirm('Opravdu chcete smazat tento z√°znam?')) {
                if (currentlyEditingRow === index) {
                    currentlyEditingRow = null;
                }
                
                // Najdeme p≈Øvodn√≠ z√°znam v hlavn√≠m datasetu
                const dateToDelete = cachedFilteredData[index].date;
                const originalIndex = consumptionData.findIndex(item => item.date === dateToDelete);
                
                if (originalIndex !== -1) {
                    consumptionData.splice(originalIndex, 1);
                    sortDataByDateDesc();
                    saveDataToStorage();
                    updateYearSelector();
                    updateSavedDataTable();
                    updateCharts();
                    displayYearlyTotals();
                }
            }
        }

        function clearForm() {
            // Nastav√≠me dne≈°n√≠ datum jako v√Ωchoz√≠
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            gasInput.value = '';
            waterInput.value = '';
            elecLowInput.value = '';
            elecHighInput.value = '';
        }

        function exportData() {
            const dataStr = JSON.stringify(consumptionData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `spotreba-energii_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        consumptionData = importedData;
                        availableYears = [...new Set(consumptionData.map(item => item.date.split('-')[0]))];
                        calculateDifferences();
                        sortDataByDateDesc();
                        saveDataToStorage();
                        updateYearSelector();
                        updateSavedDataTable();
                        updateCharts();
                        displayYearlyTotals();
                        alert('Data √∫spƒõ≈°nƒõ importov√°na!');
                    } else {
                        alert('Neplatn√Ω form√°t dat!');
                    }
                } catch (error) {
                    alert('Chyba p≈ôi ƒçten√≠ souboru: ' + error.message);
                }
                event.target.value = ''; // Reset file input
            };
            reader.readAsText(file);
        }

        // Diagnostick√© funkce
        function measureFilterPerformance() {
            const years = ['all', ...availableYears];
            console.group('V√Ωkonnostn√≠ test filtrace');
            years.forEach(year => {
                const start = performance.now();
                const filtered = year === 'all' 
                    ? [...consumptionData] 
                    : consumptionData.filter(item => item.date.startsWith(year));
                console.log(`Filtrace ${year}: ${filtered.length} z√°znam≈Ø za ${(performance.now() - start).toFixed(2)}ms`);
            });
            console.groupEnd();
        }
    </script>
</body>
</html>